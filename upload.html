<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skate Session Logger | TAMU Edition (API Active)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind config to define Aggie Maroon
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'aggie-maroon': '#500000', // Primary TAMU color
                        'maroon-hover': '#3e0000', // Slightly darker for hover states
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom font import for a cleaner look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            /* Light, inviting background */
            background-color: #f1f5f9; /* bg-slate-100 */
        }

        /* Hide the default file input text */
        input[type="file"] {
            color: transparent;
        }

        /* Style the video player controls */
        #video-preview {
            max-height: 400px;
            object-fit: contain;
            width: 100%;
            border-radius: 0.75rem; /* rounded-xl */
        }
    </style>
    <script type="module">
    
    // --- API Configuration (Active) ---
    // Set this to your running FastAPI server address.
    const API_BASE_URL = 'http://127.0.0.1:8000'; 

    // --- Utility Functions ---
    
    function showPage(pageId) {
        document.getElementById('submission-page').classList.add('hidden');
        document.getElementById('leaderboard-page').classList.add('hidden');
        document.getElementById(pageId).classList.remove('hidden');

        document.getElementById('nav-submit').classList.remove('bg-aggie-maroon', 'text-white');
        document.getElementById('nav-leaderboard').classList.remove('bg-aggie-maroon', 'text-white');
        document.getElementById('nav-submit').classList.add('bg-gray-200', 'text-gray-700');
        document.getElementById('nav-leaderboard').classList.add('bg-gray-200', 'text-gray-700');

        if (pageId === 'submission-page') {
            document.getElementById('nav-submit').classList.add('bg-aggie-maroon', 'text-white');
            document.getElementById('nav-submit').classList.remove('bg-gray-200', 'text-gray-700');
        } else if (pageId === 'leaderboard-page') {
            document.getElementById('nav-leaderboard').classList.add('bg-aggie-maroon', 'text-white');
            document.getElementById('nav-leaderboard').classList.remove('bg-gray-200', 'text-gray-700');
            // Automatically refresh leaderboard when switching to this page
            loadLeaderboard();
        }
    }

    function showMessage(message, type = 'info') {
        const messageBox = document.getElementById('message-box');
        messageBox.textContent = message;
        messageBox.className = 'p-3 rounded-xl text-center font-medium mt-4';
        
        if (type === 'success') {
            messageBox.classList.add('bg-green-100', 'text-green-800');
        } else if (type === 'error') {
            messageBox.classList.add('bg-red-100', 'text-red-800');
        } else {
            messageBox.classList.add('bg-aggie-maroon', 'text-white');
        }
        
        messageBox.classList.remove('hidden');
        setTimeout(() => {
            messageBox.classList.add('hidden');
        }, 5000);
    }

    function handleVideoUpload(event) {
        const file = event.target.files[0];
        const videoPreview = document.getElementById('video-preview');
        const videoContainer = document.getElementById('video-container');
        const placeholder = document.getElementById('placeholder-text');

        if (file && file.type.startsWith('video/')) {
            const fileURL = URL.createObjectURL(file);
            videoPreview.src = fileURL;
            videoPreview.classList.remove('hidden');
            placeholder.classList.add('hidden');
            videoContainer.classList.add('p-0');
            videoContainer.classList.remove('border-gray-300');
            showMessage(`Video file selected: ${file.name}`, 'info');
            
            // Simulate score calculation when a video is loaded (Score is out of 100)
            const score = parseFloat((Math.random() * (100 - 60) + 60).toFixed(2));
            document.getElementById('score-output-display').textContent = `SCORE: ${score.toFixed(2)}`;
            
        } else {
            videoPreview.src = '';
            videoPreview.classList.add('hidden');
            placeholder.classList.remove('hidden');
            videoContainer.classList.remove('p-0');
            videoContainer.classList.add('border-gray-300');
            document.getElementById('score-output-display').textContent = 'SCORE: 0.00';
            if (file) {
                console.error("Selected file is not a video:", file.type);
            }
        }
    }
    
    // --- LEADERBOARD RENDERING HELPER ---

    function renderLeaderboard(entries) {
        const leaderboardList = document.getElementById('leaderboard-list');
        leaderboardList.innerHTML = ''; 

        entries.forEach((entry) => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center py-3 px-4 border-b border-gray-200 last:border-b-0 hover:bg-gray-50 transition duration-150';
            
            // Determine color based on rank for top 3
            const rankColor = entry.rank <= 3 ? 'aggie-maroon' : 'gray-500';

            li.innerHTML = `
                <span class="font-extrabold text-2xl w-10 text-center text-${rankColor}">${entry.rank}</span>
                <div class="flex-1 min-w-0 pr-4">
                    <span class="block font-medium text-gray-900 uppercase truncate">${entry.name}</span>
                    <span class="block text-sm text-gray-500 truncate">${entry.trick_name || 'N/A'}</span>
                </div>
                <span class="font-extrabold text-2xl text-${rankColor}">${entry.score.toFixed(2)} pts</span>
            `;
            leaderboardList.appendChild(li);
        });
    }


    // --- API LEADERBOARD LOADER ---

    async function loadLeaderboard() {
        const leaderboardList = document.getElementById('leaderboard-list');
        const refreshButton = document.getElementById('refresh-rankings-btn');
        leaderboardList.innerHTML = '<li class="text-center text-gray-500 py-6">Loading rankings...</li>'; 
        refreshButton.disabled = true;
        refreshButton.textContent = 'REFRESHING...';

        try {
            // Fetch data from the FastAPI /leaderboard endpoint
            const response = await fetch(`${API_BASE_URL}/leaderboard`);
            // FastAPI returns a Tuple[str, List[LeaderboardEntry]]
            const [statusMessage, entries] = await response.json(); 

            if (!response.ok || statusMessage !== 'success') {
                throw new Error(statusMessage || 'API returned a non-success status.');
            }
            
            const rankedEntries = entries.map((entry, index) => ({
                rank: index + 1,
                name: entry.name,
                trick_name: entry.trick_name.toUpperCase(),
                score: entry.score
            }));

            if (rankedEntries.length === 0) {
                leaderboardList.innerHTML = '<li class="text-center text-gray-500 py-4">NO RUNS LOGGED YET. DROP IN!</li>';
                showMessage('Successfully connected, but no entries found.', 'success');
            } else {
                renderLeaderboard(rankedEntries);
                showMessage('Rankings loaded successfully from API!', 'success');
            }

        } catch (error) {
            console.error("Error loading leaderboard:", error);
            showMessage("CRITICAL ERROR: Failed to connect to backend API. Is it running?", 'error');
            leaderboardList.innerHTML = `<li class="text-center text-red-500 py-4">CONNECTION ERROR: Cannot load rankings.</li>`;
        } finally {
            refreshButton.disabled = false;
            refreshButton.textContent = 'REFRESH RANKINGS';
        }
    }

    // --- API SUBMISSION HANDLER (MODIFIED FOR FILE UPLOAD) ---

    async function handleSubmission() {
        // 1. Collect and validate data
        const nameInput = document.getElementById('name-input');
        const trickInput = document.getElementById('trick-name-input');
        const videoInput = document.getElementById('video-input');
        const scoreDisplay = document.getElementById('score-output-display');
        
        const name = nameInput.value.trim();
        const trick_name = trickInput.value.trim();
        const video_file = videoInput.files[0];
        
        // Extract the displayed score for submission (ensuring it's between 0 and 100)
        const scoreMatch = scoreDisplay.textContent.match(/SCORE: ([\d.]+)/);
        let score = scoreMatch ? parseFloat(scoreMatch[1]) : 0.0;
        score = Math.min(100, Math.max(0, score)); // Clamp score between 0 and 100

        if (!name || !trick_name) {
            showMessage('Error: Please enter your Skate Alias and Trick Name.', 'error');
            return;
        }
        
        if (videoInput.files.length === 0 || !video_file) {
                showMessage('Error: Please upload a video file for evidence.', 'error');
            return;
        }

        // 2. Prepare payload using FormData
        // FormData is required for file uploads and will be read by your FastAPI backend
        // (assuming the backend endpoint is configured to accept a File/UploadFile).
        const formData = new FormData();
        formData.append('video_file', video_file); // Key must match the backend's expected field name
        formData.append('name', name);
        formData.append('trick_name', trick_name);
        formData.append('score', score.toFixed(2)); // Send score as a string with 2 decimal places
        
        const response = await fetch(`${API_BASE_URL}/submit_run`, { // Matches corrected backend path
            method: 'POST',
            body: formData
        });
        // 3. Send data to FastAPI
        try {
            const response = await fetch(`${API_BASE_URL}/submit_run`, {
                method: 'POST',
                // IMPORTANT: Do NOT set Content-Type header manually for FormData. 
                // The browser sets it automatically with the correct boundary.
                body: formData 
            });

            if (!response.ok) {
                // Try to parse server error response if available
                let errorDetails = 'Submission failed on server.';
                try {
                    const error = await response.json();
                    errorDetails = error.detail || errorDetails;
                } catch {} // Ignore parsing error if response isn't JSON
                throw new Error(errorDetails);
            }

            const [status, data] = await response.json();
            
            showMessage(`SUCCESS! Run for "${data.trick_name}" submitted with score ${data.score.toFixed(2)} / 100.`, 'success');
            
            // Clear the form fields upon success and reset the score display
            nameInput.value = '';
            trickInput.value = '';
            scoreDisplay.textContent = 'SCORE: 0.00';
            // Reset video input and preview
            videoInput.value = null; 
            document.getElementById('video-preview').src = '';
            document.getElementById('video-preview').classList.add('hidden');
            document.getElementById('placeholder-text').classList.remove('hidden');
            
            // Load leaderboard to show the new ranking
            loadLeaderboard(); 

        } catch (error) {
            console.error("Submission Error:", error);
            showMessage(`SUBMISSION FAILED: Cannot connect to API or server error. (${error.message})`, 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'DROP IN & SUBMIT SCORE';
        }
    }


    // --- Event Listeners and Initialization ---

    window.onload = function() {
        const videoInput = document.getElementById('video-input');
        const saveBtn = document.getElementById('save-analysis-btn');

        if (videoInput) {
            videoInput.addEventListener('change', handleVideoUpload);
        }
        
        if (saveBtn) {
            saveBtn.addEventListener('click', handleSubmission);
        }
        
        document.getElementById('nav-submit').addEventListener('click', () => showPage('submission-page'));
        document.getElementById('nav-leaderboard').addEventListener('click', () => showPage('leaderboard-page'));
        document.getElementById('refresh-rankings-btn').addEventListener('click', loadLeaderboard); // Ensure the button is properly hooked

        // Initial view setup
        showPage('submission-page');
        
        // Set initial score display
        document.getElementById('score-output-display').textContent = 'SCORE: 0.00';
    };
    </script>
</head>
<body class="flex items-start justify-center min-h-screen p-4 sm:p-6">

    <!-- Main Content Card -->
    <div class="w-full max-w-2xl bg-white shadow-2xl rounded-2xl p-6 sm:p-8 space-y-8 border-4 border-aggie-maroon">

        <header class="mb-6">
            <h1 class="text-4xl font-extrabold text-gray-900 text-center tracking-widest uppercase border-b-4 border-gray-200 pb-3">
                <span class="text-aggie-maroon">TAMU</span> Skate Log
            </h1>
            <p class="mt-2 text-center text-gray-600 font-semibold">LOG YOUR SESSION. CHECK THE RANKINGS. GIG 'EM!</p>
        </header>
        
        <!-- Navigation Bar -->
        <nav class="flex space-x-2 bg-gray-100 p-2 rounded-xl shadow-inner">
            <button id="nav-submit" class="flex-1 py-3 px-4 rounded-lg font-bold text-lg uppercase transition duration-150 ease-in-out">
                Submit Run
            </button>
            <button id="nav-leaderboard" class="flex-1 py-3 px-4 rounded-lg font-bold text-lg uppercase transition duration-150 ease-in-out">
                Leaderboard
            </button>
        </nav>

        <!-- Message Box -->
        <div id="message-box" class="hidden"></div>


        <!-- === 1. SUBMISSION PAGE === -->
        <div id="submission-page" class="space-y-8">
            
            <!-- 1. Name Input Section -->
            <section class="space-y-3">
                <label for="name-input" class="block text-sm font-bold text-gray-700 uppercase">1. SKATE ALIAS</label>
                <input type="text" id="name-input" placeholder="Your Skate Name" maxlength="25"
                       class="w-full px-4 py-3 border-2 border-gray-300 bg-white text-gray-900 rounded-xl focus:ring-4 focus:ring-aggie-maroon focus:border-aggie-maroon shadow-sm transition duration-150 ease-in-out uppercase font-semibold placeholder-gray-400">
            </section>
            
            <!-- 2. Trick Name Input Section (NEW) -->
            <section class="space-y-3">
                <label for="trick-name-input" class="block text-sm font-bold text-gray-700 uppercase">2. TRICK NAME / VARIATION</label>
                <input type="text" id="trick-name-input" placeholder="e.g., Kickflip, Backside 360" maxlength="50"
                       class="w-full px-4 py-3 border-2 border-gray-300 bg-white text-gray-900 rounded-xl focus:ring-4 focus:ring-aggie-maroon focus:border-aggie-maroon shadow-sm transition duration-150 ease-in-out uppercase font-semibold placeholder-gray-400">
            </section>

            <!-- 3. Score Display Section -->
            <section class="space-y-3">
                <label class="block text-sm font-bold text-gray-700 uppercase">3. SESSION SCORE (OUTPUT: 0-100)</label>
                <div id="score-output-display" 
                     class="w-full px-4 py-3 border-2 border-aggie-maroon bg-yellow-100 text-gray-900 text-3xl font-extrabold text-center rounded-xl shadow-xl shadow-yellow-200 min-h-[56px] flex items-center justify-center tracking-wider">
                    SCORE: 0.00
                </div>
            </section>

            <!-- 4. Video Upload Section -->
            <section class="space-y-3">
                <label class="block text-sm font-bold text-gray-700 uppercase">4. UPLOAD EVIDENCE VIDEO</label>
                
                <div id="video-container" class="relative w-full aspect-video bg-gray-100 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center p-10 transition duration-300 ease-in-out">
                    
                    <video id="video-preview" controls class="hidden shadow-lg border-2 border-aggie-maroon" playsinline preload="metadata"></video>
                    
                    <p id="placeholder-text" class="text-gray-500 text-center select-none font-semibold">
                        NO FOOTAGE. SELECT FILE TO PREVIEW. ONLY .MOV FILES.
                    </p>
                    
                    <input type="file" id="video-input" accept="video/*" class="absolute inset-0 opacity-0 cursor-pointer" aria-label="Select a video file to upload">
                </div>
                
                <div class="mt-4">
                    <label for="video-input" class="block text-center cursor-pointer bg-aggie-maroon text-white py-3 rounded-xl hover:bg-maroon-hover transition duration-150 ease-in-out font-extrabold uppercase shadow-md">
                        CHOOSE VIDEO FILE
                    </label>
                </div>
            </section>

            <!-- Action Button -->
            <div class="pt-4">
                <button id="save-analysis-btn" 
                        class="w-full bg-green-600 text-white py-4 rounded-xl font-black text-xl hover:bg-green-700 transition duration-150 ease-in-out shadow-2xl shadow-green-500/50 uppercase tracking-wider">
                    DROP IN & SUBMIT SCORE
                </button>
            </div>
        </div>
        
        <!-- === 2. LEADERBOARD PAGE === -->
        <div id="leaderboard-page" class="space-y-6 hidden">
            <h2 class="text-3xl font-extrabold text-aggie-maroon mb-4 text-center tracking-wide uppercase">
                GLOBAL RANKINGS
            </h2>
            <div class="bg-white border-2 border-gray-300 rounded-xl shadow-lg overflow-hidden">
                <ul id="leaderboard-list">
                    <!-- Leaderboard content will be injected here by JavaScript -->
                    <li class="text-center text-gray-500 py-6">Initializing...</li>
                </ul>
            </div>
            
            <button id="refresh-rankings-btn" onclick="loadLeaderboard()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold uppercase hover:bg-gray-300 transition duration-150">
                REFRESH RANKINGS
            </button>
        </div>

        
        <footer class="text-center text-xs text-gray-500 mt-6 font-mono">
            AGGIE CODEBASE // API ACTIVE
        </footer>
    </div>

</body>
</html>
